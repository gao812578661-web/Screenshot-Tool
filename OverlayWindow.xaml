<Window x:Class="RefScrn.OverlayWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="OverlayWindow" 
        WindowStyle="None" 
        ResizeMode="NoResize" 
        Topmost="True" 
        ShowInTaskbar="False"
        AllowsTransparency="True"
        Background="Transparent">
    <Window.Resources>
        <DropShadowEffect x:Key="DropShadowEffect" BlurRadius="10" ShadowDepth="2" Direction="270" Color="#444444" Opacity="0.3"/>
        <Style x:Key="ColorButtonStyle" TargetType="Button">
            <Setter Property="Width" Value="24"/>
            <Setter Property="Height" Value="24"/>
            <Setter Property="Margin" Value="4"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Grid>
                            <Ellipse Fill="{TemplateBinding Background}" Stroke="Gray" StrokeThickness="1"/>
                            <Ellipse x:Name="SelectionRing" Stroke="White" StrokeThickness="2" Margin="2" Visibility="Collapsed"/>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="SelectionRing" Property="Visibility" Value="Visible"/>
                                <Setter TargetName="SelectionRing" Property="Stroke" Value="#DDDDDD"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid>
        <!-- Background Image (Screenshot) -->
        <Image x:Name="BackgroundImage" Stretch="None" HorizontalAlignment="Left" VerticalAlignment="Top"/>
        
        <!-- Mask Layer (Darken outside selection) -->
        <Path x:Name="MaskPath" Fill="#80000000" Stretch="None" IsHitTestVisible="False"/>

        <!-- Annotation Drawing Layer -->
        <Canvas x:Name="AnnotationCanvas" IsHitTestVisible="True" Background="#01000000"/>

        <!-- Canvas for Selection UI -->
        <Canvas x:Name="SelectionCanvas" IsHitTestVisible="False">
            <Rectangle x:Name="SelectionRect" Stroke="#07C160" StrokeThickness="4" Visibility="Collapsed"/>
        </Canvas>

        <!-- UI Overlay Layer (Toolbar, Labels) -->
        <Canvas x:Name="UIOverlayCanvas">
            <!-- Resolution Label -->
            <Border x:Name="SizeLabel" Background="#333333" CornerRadius="2" Padding="4,2" Visibility="Collapsed" Canvas.Left="0" Canvas.Top="0">
                <TextBlock x:Name="SizeText" Text="0 x 0" Foreground="White" FontSize="12"/>
            </Border>
            
            <!-- Toolbar -->
            <StackPanel x:Name="ToolbarArea" Canvas.Left="0" Canvas.Top="0" Visibility="Collapsed">
                <!-- Main Tools -->
                <Border x:Name="ToolbarPanel" IsHitTestVisible="True" Background="White" BorderBrush="#EEEEEE" BorderThickness="1" CornerRadius="4" Effect="{StaticResource DropShadowEffect}">
                    <Border.Resources>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="BorderThickness" Value="0"/>
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="HorizontalContentAlignment" Value="Center"/>
                            <Setter Property="VerticalContentAlignment" Value="Center"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border x:Name="Border" Background="{TemplateBinding Background}" CornerRadius="2">
                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Border" Property="Background" Value="#F2F2F2"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Border.Resources>
                    <StackPanel Orientation="Horizontal" Margin="6">
                        <!-- Annotation Tools -->
                        <Button x:Name="RectBtn" Width="34" Height="34" Margin="2,0" Click="OnToolClick" ToolTip="矩形" Tag="Rectangle">
                            <Viewbox Width="18" Height="18">
                                <Rectangle Width="26" Height="20" Stroke="#333333" StrokeThickness="2" RadiusX="1" RadiusY="1"/>
                            </Viewbox>
                        </Button>
                        <Button x:Name="EllipseBtn" Width="34" Height="34" Margin="2,0" Click="OnToolClick" ToolTip="椭圆" Tag="Ellipse">
                            <Viewbox Width="18" Height="18">
                                <Ellipse Width="26" Height="20" Stroke="#333333" StrokeThickness="2"/>
                            </Viewbox>
                        </Button>
                        <Button x:Name="ArrowBtn" Width="34" Height="34" Margin="2,0" Click="OnToolClick" ToolTip="箭头" Tag="Arrow">
                            <Viewbox Width="18" Height="18">
                                <Path Data="M4,10 L24,10 M18,4 L24,10 L18,16" Stroke="#333333" StrokeThickness="2.5" StrokeLineJoin="Round" StrokeStartLineCap="Round" StrokeEndLineCap="Round"/>
                            </Viewbox>
                        </Button>
                        <Button x:Name="BrushBtn" Width="34" Height="34" Margin="2,0" Click="OnToolClick" ToolTip="画笔" Tag="Brush">
                            <Viewbox Width="18" Height="18">
                                <Path Data="M7,22 L11,22 L22,11 L18,7 L7,18 Z M16,9 L20,13" Stroke="#333333" StrokeThickness="1.5" StrokeLineJoin="Round"/>
                            </Viewbox>
                        </Button>
                        <Button x:Name="TextBtn" Width="34" Height="34" Margin="2,0" Click="OnToolClick" ToolTip="文字" Tag="Text">
                            <Viewbox Width="16" Height="16">
                                <TextBlock Text="A" FontSize="24" FontWeight="Bold" Foreground="#333333" FontFamily="Times New Roman"/>
                            </Viewbox>
                        </Button>
                        <Rectangle Width="1" Height="18" Fill="#EEEEEE" Margin="6,0" VerticalAlignment="Center"/>
                        <!-- Actions -->
                        <Button Width="34" Height="34" Margin="2,0" Click="OnSaveClick" ToolTip="保存">
                            <Viewbox Width="20" Height="20" HorizontalAlignment="Center" VerticalAlignment="Center">
                                <Path Data="M6,20 L6,26 L26,26 L26,20 M16,8 L16,23 M11,18 L16,23 L21,18" Stroke="#333333" StrokeThickness="2" StrokeLineJoin="Round" StrokeEndLineCap="Round" StrokeStartLineCap="Round"/>
                            </Viewbox>
                        </Button>
                        <Rectangle Width="1" Height="18" Fill="#EEEEEE" Margin="6,0" VerticalAlignment="Center"/>
                        <Button Width="34" Height="34" Margin="2,0" Click="OnCancelClick" ToolTip="取消">
                            <Viewbox Width="16" Height="16" HorizontalAlignment="Center" VerticalAlignment="Center">
                                <Path Data="M8,8 L24,24 M24,8 L8,24" Stroke="#FF4444" StrokeThickness="3" StrokeEndLineCap="Round" StrokeStartLineCap="Round"/>
                            </Viewbox>
                        </Button>
                        <Button Width="34" Height="34" Margin="2,0" Click="OnConfirmClick" ToolTip="完成">
                            <Viewbox Width="18" Height="18" HorizontalAlignment="Center" VerticalAlignment="Center">
                                <Path Data="M9,18 L15,24 L26,10" Stroke="#07C160" StrokeThickness="3" StrokeEndLineCap="Round" StrokeStartLineCap="Round"/>
                            </Viewbox>
                        </Button>
                    </StackPanel>
                </Border>
                
                <!-- Color Palette -->
                <Border x:Name="ColorPanel" Margin="0,5,0,0" IsHitTestVisible="True" Background="White" BorderBrush="#EEEEEE" BorderThickness="1" CornerRadius="4" Visibility="Collapsed" Effect="{StaticResource DropShadowEffect}" HorizontalAlignment="Left">
                    <StackPanel Orientation="Horizontal" Margin="4">
                        <Button Style="{StaticResource ColorButtonStyle}" Background="#FF3B30" Click="OnColorClick"/> <!-- Red -->
                        <Button Style="{StaticResource ColorButtonStyle}" Background="#FF9500" Click="OnColorClick"/> <!-- Orange -->
                        <Button Style="{StaticResource ColorButtonStyle}" Background="#FFCC00" Click="OnColorClick"/> <!-- Yellow -->
                        <Button Style="{StaticResource ColorButtonStyle}" Background="#4CD964" Click="OnColorClick"/> <!-- Green -->
                        <Button Style="{StaticResource ColorButtonStyle}" Background="#007AFF" Click="OnColorClick"/> <!-- Blue -->
                        <Button Style="{StaticResource ColorButtonStyle}" Background="#5856D6" Click="OnColorClick"/> <!-- Purple -->
                        <Button Style="{StaticResource ColorButtonStyle}" Background="#000000" Click="OnColorClick"/> <!-- Black -->
                        <Button Style="{StaticResource ColorButtonStyle}" Background="#FFFFFF" Click="OnColorClick"/> <!-- White -->
                    </StackPanel>
                </Border>
            </StackPanel>
        </Canvas>
    </Grid>
</Window>