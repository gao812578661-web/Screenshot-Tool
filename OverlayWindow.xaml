<Window x:Class="RefScrn.OverlayWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="OverlayWindow" 
        WindowStyle="None" 
        ResizeMode="NoResize" 
        Topmost="True" 
        ShowInTaskbar="False"
        AllowsTransparency="True"
        Background="Transparent">
    <Window.Resources>
        <DropShadowEffect x:Key="DropShadowEffect" BlurRadius="10" ShadowDepth="2" Direction="270" Color="#444444" Opacity="0.3"/>
        <Style x:Key="ColorButtonStyle" TargetType="Button">
            <Setter Property="Width" Value="24"/>
            <Setter Property="Height" Value="24"/>
            <Setter Property="Margin" Value="4"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Grid>
                            <Ellipse Fill="{TemplateBinding Background}" Stroke="Gray" StrokeThickness="1"/>
                            <Ellipse x:Name="SelectionRing" Stroke="White" StrokeThickness="2" Margin="2" Visibility="Collapsed"/>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="SelectionRing" Property="Visibility" Value="Visible"/>
                                <Setter TargetName="SelectionRing" Property="Stroke" Value="#DDDDDD"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid>
        <!-- Background Image (Screenshot) -->
        <Image x:Name="BackgroundImage" Stretch="None" HorizontalAlignment="Left" VerticalAlignment="Top"/>
        
        <!-- Mask Layer (Darken outside selection) -->
        <Path x:Name="MaskPath" Fill="#80000000" Stretch="None" IsHitTestVisible="False"/>

        <!-- Annotation Drawing Layer -->
        <Canvas x:Name="AnnotationCanvas" IsHitTestVisible="True" Background="#01000000"/>

        <!-- Canvas for Selection UI -->
        <Canvas x:Name="SelectionCanvas" IsHitTestVisible="False">
            <Rectangle x:Name="SelectionRect" Stroke="#07C160" StrokeThickness="4" Visibility="Collapsed"/>
        </Canvas>

        <!-- UI Overlay Layer (Toolbar, Labels) -->
        <Canvas x:Name="UIOverlayCanvas">
            <!-- Translation Result Overlay (Container for line-by-line mapping) -->
            <Canvas x:Name="TranslationResultOverlay" Visibility="Collapsed" IsHitTestVisible="False"/>

            <!-- Resolution Label -->
            <Border x:Name="SizeLabel" Background="#333333" CornerRadius="2" Padding="4,2" Visibility="Collapsed" Canvas.Left="0" Canvas.Top="0">
                <TextBlock x:Name="SizeText" Text="0 x 0" Foreground="White" FontSize="12"/>
            </Border>
            
            <!-- Toolbar -->
            <StackPanel x:Name="ToolbarArea" Canvas.Left="0" Canvas.Top="0" Visibility="Collapsed">
                <!-- Main Tools -->
                <Border x:Name="ToolbarPanel" IsHitTestVisible="True" Background="White" BorderBrush="#EEEEEE" BorderThickness="1" CornerRadius="4" Effect="{StaticResource DropShadowEffect}">
                    <Border.Resources>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="BorderThickness" Value="0"/>
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="HorizontalContentAlignment" Value="Center"/>
                            <Setter Property="VerticalContentAlignment" Value="Center"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border x:Name="Border" Background="{TemplateBinding Background}" CornerRadius="2">
                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Border" Property="Background" Value="#F2F2F2"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Border.Resources>
                    <StackPanel Orientation="Horizontal" Margin="6">
                        <!-- Annotation Tools -->
                        <Button x:Name="RectBtn" Width="34" Height="34" Margin="2,0" Click="OnToolClick" ToolTip="矩形" Tag="Rectangle">
                            <Viewbox Width="18" Height="18">
                                <Rectangle Width="26" Height="20" Stroke="#333333" StrokeThickness="2" RadiusX="1" RadiusY="1"/>
                            </Viewbox>
                        </Button>
                        <Button x:Name="EllipseBtn" Width="34" Height="34" Margin="2,0" Click="OnToolClick" ToolTip="椭圆" Tag="Ellipse">
                            <Viewbox Width="18" Height="18">
                                <Ellipse Width="26" Height="20" Stroke="#333333" StrokeThickness="2"/>
                            </Viewbox>
                        </Button>
                        <Button x:Name="ArrowBtn" Width="34" Height="34" Margin="2,0" Click="OnToolClick" ToolTip="箭头" Tag="Arrow">
                            <Viewbox Width="18" Height="18">
                                <Path Data="M4,10 L24,10 M18,4 L24,10 L18,16" Stroke="#333333" StrokeThickness="2.5" StrokeLineJoin="Round" StrokeStartLineCap="Round" StrokeEndLineCap="Round"/>
                            </Viewbox>
                        </Button>
                        <Button x:Name="BrushBtn" Width="34" Height="34" Margin="2,0" Click="OnToolClick" ToolTip="画笔" Tag="Brush">
                            <Viewbox Width="18" Height="18">
                                <Path Data="M3,18 L7,18 L18,7 L14,3 L3,14 Z M12,5 L16,9" Stroke="#333333" StrokeThickness="1.5" StrokeLineJoin="Round"/>
                            </Viewbox>
                        </Button>
                        <Button x:Name="TextBtn" Width="34" Height="34" Margin="2,0" Click="OnToolClick" ToolTip="文字" Tag="Text">
                            <Viewbox Width="18" Height="18">
                                <Border Width="24" Height="24" BorderBrush="#333333" BorderThickness="2" CornerRadius="1">
                                    <TextBlock Text="T" FontSize="18" FontWeight="Bold" Foreground="#333333" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                            </Viewbox>
                        </Button>
                        <Button x:Name="MosaicBtn" Width="34" Height="34" Margin="2,0" Click="OnToolClick" ToolTip="马赛克" Tag="Mosaic">
                            <Viewbox Width="18" Height="18">
                                <Border Width="24" Height="24" BorderBrush="#333333" BorderThickness="2" CornerRadius="1">
                                    <Canvas Width="20" Height="20">
                                        <!-- 4x4 网格图案 -->
                                        <Rectangle Width="4" Height="4" Canvas.Left="2" Canvas.Top="2" Fill="#333333"/>
                                        <Rectangle Width="4" Height="4" Canvas.Left="6" Canvas.Top="2" Fill="Transparent" Stroke="#333333" StrokeThickness="0.5"/>
                                        <Rectangle Width="4" Height="4" Canvas.Left="10" Canvas.Top="2" Fill="#333333"/>
                                        <Rectangle Width="4" Height="4" Canvas.Left="14" Canvas.Top="2" Fill="Transparent" Stroke="#333333" StrokeThickness="0.5"/>
                                        <Rectangle Width="4" Height="4" Canvas.Left="2" Canvas.Top="6" Fill="Transparent" Stroke="#333333" StrokeThickness="0.5"/>
                                        <Rectangle Width="4" Height="4" Canvas.Left="6" Canvas.Top="6" Fill="#333333"/>
                                        <Rectangle Width="4" Height="4" Canvas.Left="10" Canvas.Top="6" Fill="Transparent" Stroke="#333333" StrokeThickness="0.5"/>
                                        <Rectangle Width="4" Height="4" Canvas.Left="14" Canvas.Top="6" Fill="#333333"/>
                                        <Rectangle Width="4" Height="4" Canvas.Left="2" Canvas.Top="10" Fill="#333333"/>
                                        <Rectangle Width="4" Height="4" Canvas.Left="6" Canvas.Top="10" Fill="Transparent" Stroke="#333333" StrokeThickness="0.5"/>
                                        <Rectangle Width="4" Height="4" Canvas.Left="10" Canvas.Top="10" Fill="#333333"/>
                                        <Rectangle Width="4" Height="4" Canvas.Left="14" Canvas.Top="10" Fill="Transparent" Stroke="#333333" StrokeThickness="0.5"/>
                                        <Rectangle Width="4" Height="4" Canvas.Left="2" Canvas.Top="14" Fill="Transparent" Stroke="#333333" StrokeThickness="0.5"/>
                                        <Rectangle Width="4" Height="4" Canvas.Left="6" Canvas.Top="14" Fill="#333333"/>
                                        <Rectangle Width="4" Height="4" Canvas.Left="10" Canvas.Top="14" Fill="Transparent" Stroke="#333333" StrokeThickness="0.5"/>
                                        <Rectangle Width="4" Height="4" Canvas.Left="14" Canvas.Top="14" Fill="#333333"/>
                                    </Canvas>
                                </Border>
                            </Viewbox>
                        </Button>
                        <Button x:Name="TranslateBtn" Width="34" Height="34" Margin="2,0" Click="OnTranslateClick" ToolTip="翻译">
                            <Viewbox Width="22" Height="22">
                                <Canvas Width="24" Height="24">
                                    <!-- Back Square with '文' -->
                                    <Path Stroke="#333333" StrokeThickness="1.5" Data="M8,8 H20 V20 H8 Z"/>
                                    <Path Fill="#333333" Data="M12,12 H16 M14,12 V17 M12,17 H16" Stroke="#333333" StrokeThickness="0.5"/> <!-- Simplified '文' symbol -->
                                    <!-- Front Square with 'A' -->
                                    <Path Fill="White" Stroke="#333333" StrokeThickness="1.5" Data="M4,4 H16 V16 H4 Z"/>
                                    <Path Fill="#333333" Data="M7,13 L10,7 L13,13 M8,11 H12" Stroke="#333333" StrokeThickness="1"/> <!-- 'A' symbol -->
                                </Canvas>
                            </Viewbox>
                        </Button>
                        <Button x:Name="OcrBtn" Width="34" Height="34" Margin="2,0" Click="OnOcrClick" ToolTip="文字识别">
                            <Viewbox Width="20" Height="20">
                                <Canvas Width="24" Height="24">
                                    <Ellipse Width="16" Height="16" Canvas.Left="2" Canvas.Top="2" Stroke="#333333" StrokeThickness="2.5" Fill="Transparent"/>
                                    <Path Data="M15,15 L21,21" Stroke="#333333" StrokeThickness="3"/>
                                    <TextBlock Text="A" FontSize="11" FontWeight="Bold" Foreground="#333333" Canvas.Left="6" Canvas.Top="4"/>
                                </Canvas>
                            </Viewbox>
                        </Button>
                        <Rectangle Width="1" Height="18" Fill="#EEEEEE" Margin="6,0" VerticalAlignment="Center"/>
                        <!-- 长截图 -->
                        <Button x:Name="LongScreenshotBtn" Width="34" Height="34" Margin="2,0" Click="OnLongScreenshotClick" ToolTip="长截图">
                            <Viewbox Width="20" Height="20">
                                <Canvas Width="24" Height="24">
                                    <Rectangle Width="14" Height="20" Canvas.Left="5" Canvas.Top="2" Stroke="#333333" StrokeThickness="1.5" Fill="Transparent"/>
                                    <Path Data="M12,6 L12,10 M9,8 L12,5 L15,8" Stroke="#333333" StrokeThickness="1.5" Fill="Transparent"/>
                                    <Path Data="M12,14 L12,18 M9,16 L12,19 L15,16" Stroke="#333333" StrokeThickness="1.5" Fill="Transparent"/>
                                </Canvas>
                            </Viewbox>
                        </Button>
                        <!-- 撤销 -->
                        <Button x:Name="UndoBtn" Width="34" Height="34" Margin="2,0" Click="OnUndoClick" ToolTip="撤销" IsEnabled="False">
                            <Button.Resources>
                                <Style TargetType="Path" x:Key="UndoArcStyle">
                                    <Setter Property="Stroke" Value="#333333"/>
                                    <Setter Property="StrokeThickness" Value="3"/>
                                    <Setter Property="Fill" Value="Transparent"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsEnabled, RelativeSource={RelativeSource AncestorType=Button}}" Value="False">
                                            <Setter Property="Stroke" Value="#AAAAAA"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                                <Style TargetType="Path" x:Key="UndoArrowStyle">
                                    <Setter Property="Fill" Value="#333333"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsEnabled, RelativeSource={RelativeSource AncestorType=Button}}" Value="False">
                                            <Setter Property="Fill" Value="#AAAAAA"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Resources>
                            <Viewbox Width="18" Height="18">
                                <Canvas Width="24" Height="24">
                                    <!-- 粗圆弧 从12点顺时针到9点 -->
                                    <Path Style="{StaticResource UndoArcStyle}" Data="M12,4 A8,8 0 1,1 4,12" />
                                    <!-- 三角箭头 -->
                                    <Path Style="{StaticResource UndoArrowStyle}" Data="M12,1 L7,4 L12,7 Z" />
                                </Canvas>
                            </Viewbox>
                        </Button>
                        <Rectangle Width="1" Height="18" Fill="#EEEEEE" Margin="6,0" VerticalAlignment="Center"/>
                        <!-- Actions -->
                        <Button Width="34" Height="34" Margin="2,0" Click="OnSaveClick" ToolTip="保存">
                            <Viewbox Width="20" Height="20" HorizontalAlignment="Center" VerticalAlignment="Center">
                                <Path Data="M6,18 L6,24 L26,24 L26,18 M16,6 L16,21 M11,16 L16,21 L21,16" Stroke="#333333" StrokeThickness="2" StrokeLineJoin="Round" StrokeEndLineCap="Round" StrokeStartLineCap="Round"/>
                            </Viewbox>
                        </Button>
                        <Rectangle Width="1" Height="18" Fill="#EEEEEE" Margin="6,0" VerticalAlignment="Center"/>
                        <Button Width="34" Height="34" Margin="2,0" Click="OnCancelClick" ToolTip="取消">
                            <Viewbox Width="16" Height="16" HorizontalAlignment="Center" VerticalAlignment="Center">
                                <Path Data="M6,6 L22,22 M22,6 L6,22" Stroke="#FF4444" StrokeThickness="3" StrokeEndLineCap="Round" StrokeStartLineCap="Round"/>
                            </Viewbox>
                        </Button>
                        <Button Width="34" Height="34" Margin="2,0" Click="OnConfirmClick" ToolTip="完成">
                            <Viewbox Width="18" Height="18" HorizontalAlignment="Center" VerticalAlignment="Center">
                                <Path Data="M7,14 L13,20 L24,6" Stroke="#07C160" StrokeThickness="3" StrokeEndLineCap="Round" StrokeStartLineCap="Round"/>
                            </Viewbox>
                        </Button>
                    </StackPanel>
                </Border>
                
                <!-- Color Palette -->
                <Border x:Name="ColorPanel" Margin="0,5,0,0" IsHitTestVisible="True" Background="White" BorderBrush="#EEEEEE" BorderThickness="1" CornerRadius="4" Visibility="Collapsed" Effect="{StaticResource DropShadowEffect}" HorizontalAlignment="Left">
                    <StackPanel Orientation="Horizontal" Margin="4">
                        <Button Style="{StaticResource ColorButtonStyle}" Background="#FF3B30" Click="OnColorClick"/> <!-- Red -->
                        <Button Style="{StaticResource ColorButtonStyle}" Background="#FF9500" Click="OnColorClick"/> <!-- Orange -->
                        <Button Style="{StaticResource ColorButtonStyle}" Background="#FFCC00" Click="OnColorClick"/> <!-- Yellow -->
                        <Button Style="{StaticResource ColorButtonStyle}" Background="#4CD964" Click="OnColorClick"/> <!-- Green -->
                        <Button Style="{StaticResource ColorButtonStyle}" Background="#007AFF" Click="OnColorClick"/> <!-- Blue -->
                        <Button Style="{StaticResource ColorButtonStyle}" Background="#5856D6" Click="OnColorClick"/> <!-- Purple -->
                        <Button Style="{StaticResource ColorButtonStyle}" Background="#000000" Click="OnColorClick"/> <!-- Black -->
                        <Button Style="{StaticResource ColorButtonStyle}" Background="#FFFFFF" Click="OnColorClick"/> <!-- White -->
                    </StackPanel>
                </Border>

            </StackPanel>
        </Canvas>
    </Grid>
</Window>